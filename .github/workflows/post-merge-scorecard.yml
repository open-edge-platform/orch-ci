---
# SPDX-FileCopyrightText: (C) 2026 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

# yamllint disable rule:line-length

name: Post-Merge Scorecard Pipeline

on:  # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      project_folder:
        description: >-
          Project subfolder where the job will run, defaults to '.'
        required: false
        default: "."
        type: string
      orch_ci_repo_ref:
        description: >-
          The ref of the orch-ci repo, including bootstrap action and scripts, defaults to 'main'
        required: false
        default: "main"
        type: string
    secrets:
      SYS_EMF_GH_TOKEN:
        required: true
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sanitize-project-folder:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      sanitized_project_name: ${{ steps.sanitize.outputs.sanitized_project_name }}
    steps:
      - name: Sanitize project folder
        id: sanitize
        env:
          INPUTS_PROJECT_FOLDER: ${{ inputs.project_folder }}
        run: |
          if [ -z "${INPUTS_PROJECT_FOLDER}" ] || [ "${INPUTS_PROJECT_FOLDER}" = "." ]; then
            SANITIZED_PROJECT_NAME="${GITHUB_REPOSITORY#"${GITHUB_REPOSITORY_OWNER}/"}"
          else
            SANITIZED_PROJECT_NAME=$(echo "${INPUTS_PROJECT_FOLDER}" | tr '/' '-')
          fi
          echo "SANITIZED_PROJECT_NAME=${SANITIZED_PROJECT_NAME}" >> "$GITHUB_ENV"
          echo "sanitized_project_name=${SANITIZED_PROJECT_NAME}" >> "$GITHUB_OUTPUT"

  scorecard:
    runs-on: ubuntu-latest
    needs: sanitize-project-folder
    permissions:
      contents: read
      security-events: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          ref: ${{ github.head_ref }}
          persist-credentials: false

      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a  # v2.4.3
        with:
          results_file: raw-scorecard.sarif
          results_format: sarif
          repo_token: ${{ secrets.SYS_EMF_GH_TOKEN }}
          publish_results: true

      - name: Upload raw Scorecard Results as Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: raw-scorecard-results
          path: raw-scorecard.sarif

  process-scorecard-results:
    runs-on: ubuntu-latest
    needs: [scorecard, sanitize-project-folder]
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Download raw results
        uses: actions/download-artifact@v7
        with:
          name: raw-scorecard-results

      - name: Remove Fuzzing check from SARIF
        run: |
          jq 'del(
                .runs[].results[]
                | select((.ruleId // "") | test("fuzz"; "i"))
              )
              | del(
                .runs[].tool.driver.rules[]
                | select((.id // "") | test("fuzz"; "i"))
              )' raw-scorecard.sarif \
            > scorecard-results-${{ needs.sanitize-project-folder.outputs.sanitized_project_name }}.sarif

      - name: Upload Scorecard Results to Code Scanning
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2  # v3.29.5
        with:
          sarif_file: scorecard-results-${{ needs.sanitize-project-folder.outputs.sanitized_project_name }}.sarif
          wait-for-processing: true

      - name: Upload Scorecard Results as Artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: scorecard-results-${{ needs.sanitize-project-folder.outputs.sanitized_project_name }}
          path: scorecard-results-${{ needs.sanitize-project-folder.outputs.sanitized_project_name }}.sarif
