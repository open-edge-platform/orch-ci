---
# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

# yamllint disable rule:line-length

name: Post-Merge Scorecard Pipeline

on:  # yamllint disable-line rule:truthy
  workflow_call:
    inputs:
      project_folder:
        description: >-
          Project subfolder where the job will run, defaults to '.'
        required: false
        default: "."
        type: string
      orch_ci_repo_ref:
        description: >-
          The ref of the orch-ci repo, including bootstrap action and scripts, defaults to 'main'
        required: false
        default: "main"
        type: string
    secrets:
      SYS_ORCH_GITHUB:
        required: true
  workflow_dispatch:

permissions: {}

jobs:
  sanitize-project-folder:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      sanitized_project_name: ${{ steps.sanitize.outputs.sanitized_project_name }}
    steps:
      - name: Sanitize project folder
        id: sanitize
        env:
          INPUTS_PROJECT_FOLDER: ${{ inputs.project_folder }}
        run: |
          if [ -z "${INPUTS_PROJECT_FOLDER}" ] || [ "${INPUTS_PROJECT_FOLDER}" = "." ]; then
            SANITIZED_PROJECT_NAME="${GITHUB_REPOSITORY#"${GITHUB_REPOSITORY_OWNER}/"}"
          else
            SANITIZED_PROJECT_NAME=$(echo "${INPUTS_PROJECT_FOLDER}" | tr '/' '-')
          fi
          echo "SANITIZED_PROJECT_NAME=${SANITIZED_PROJECT_NAME}" >> "$GITHUB_ENV"
          echo "sanitized_project_name=${SANITIZED_PROJECT_NAME}" >> "$GITHUB_OUTPUT"

  scorecard:
    runs-on: ubuntu-latest
    needs: sanitize-project-folder
    permissions:
      contents: read
      security-events: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # v5.0.1
        with:
          ref: ${{ github.head_ref }}
          persist-credentials: false

      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a  # v2.4.3
        with:
          results_file: raw-scorecard.sarif
          results_format: sarif
          repo_token: ${{ secrets.SYS_ORCH_GITHUB }}
          publish_results: true

      - name: Upload raw Scorecard Results as Artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: raw-scorecard-results
          path: raw-scorecard.sarif

  process-scorecard-results:
    runs-on: ubuntu-latest
    needs: [scorecard, sanitize-project-folder]
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.1

      - name: Download raw results
        uses: actions/download-artifact@v6
        with:
          name: raw-scorecard-results

      - name: Remove Fuzzing check from SARIF
        run: |
          jq 'del(
                .runs[].results[]
                | select((.ruleId // "") | test("fuzz"; "i"))
              )
              | del(
                .runs[].tool.driver.rules[]
                | select((.id // "") | test("fuzz"; "i"))
              )' raw-scorecard.sarif \
            > scorecard-results-${{ needs.sanitize-project-folder.outputs.sanitized_project_name }}.sarif

      - name: Upload Scorecard Results to Code Scanning
        uses: github/codeql-action/upload-sarif@014f16e7ab1402f30e7c3329d33797e7948572db  # v3.29.5
        with:
          sarif_file: scorecard-results-${{ needs.sanitize-project-folder.outputs.sanitized_project_name }}.sarif
          wait-for-processing: true

      - name: Upload Scorecard Results as Artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: scorecard-results-${{ needs.sanitize-project-folder.outputs.sanitized_project_name }}
          path: scorecard-results-${{ needs.sanitize-project-folder.outputs.sanitized_project_name }}.sarif
